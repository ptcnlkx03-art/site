import React, { useState } from 'react';

interface ComplexNumber {
  real: number;
  imaginary: number;
}

interface Solution {
  roots: ComplexNumber[];
  realRoots: number[];
  discriminant: number;
  nature: string;
}

const QuarticEquationSolver: React.FC = () => {
  const [coefficients, setCoefficients] = useState({
    a: 1,
    b: 0,
    c: 0,
    d: 0,
    e: 0
  });
  
  const [solution, setSolution] = useState<Solution | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string>('');

  // Complex number operations
  const complexSqrt = (num: ComplexNumber): ComplexNumber => {
    if (num.imaginary === 0) {
      const real = Math.sqrt(Math.abs(num.real));
      return {
        real: num.real >= 0 ? real : 0,
        imaginary: num.real >= 0 ? 0 : real
      };
    }
    
    const magnitude = Math.sqrt(num.real * num.real + num.imaginary * num.imaginary);
    const real = Math.sqrt((magnitude + num.real) / 2);
    const imaginary = Math.sign(num.imaginary) * Math.sqrt((magnitude - num.real) / 2);
    
    return { real, imaginary };
  };

  const complexAdd = (a: ComplexNumber, b: ComplexNumber): ComplexNumber => ({
    real: a.real + b.real,
    imaginary: a.imaginary + b.imaginary
  });

  const complexSubtract = (a: ComplexNumber, b: ComplexNumber): ComplexNumber => ({
    real: a.real - b.real,
    imaginary: a.imaginary - b.imaginary
  });

  const complexMultiply = (a: ComplexNumber, b: ComplexNumber): ComplexNumber => ({
    real: a.real * b.real - a.imaginary * b.imaginary,
    imaginary: a.real * b.imaginary + a.imaginary * b.real
  });

  const complexDivide = (a: ComplexNumber, b: ComplexNumber): ComplexNumber => {
    const denominator = b.real * b.real + b.imaginary * b.imaginary;
    return {
      real: (a.real * b.real + a.imaginary * b.imaginary) / denominator,
      imaginary: (a.imaginary * b.real - a.real * b.imaginary) / denominator
    };
  };

  // Solve quadratic equation ax² + bx + c = 0
  const solveQuadratic = (a: number, b: number, c: number): ComplexNumber[] => {
    const discriminant = b * b - 4 * a * c;
    
    if (discriminant >= 0) {
      const sqrtDisc = Math.sqrt(discriminant);
      return [
        { real: (-b + sqrtDisc) / (2 * a), imaginary: 0 },
        { real: (-b - sqrtDisc) / (2 * a), imaginary: 0 }
      ];
    } else {
      const real = -b / (2 * a);
      const imaginary = Math.sqrt(-discriminant) / (2 * a);
      return [
        { real, imaginary },
        { real, imaginary: -imaginary }
      ];
    }
  };

  // Solve cubic equation using depressed cubic method
  const solveCubic = (a: number, b: number, c: number, d: number): ComplexNumber[] => {
    if (a === 0) return solveQuadratic(b, c, d);
    
    // Convert to depressed cubic: t³ + pt + q = 0
    const p = (3 * a * c - b * b) / (3 * a * a);
    const q = (2 * b * b * b - 9 * a * b * c + 27 * a * a * d) / (27 * a * a * a);
    
    const discriminant = (q * q) / 4 + (p * p * p) / 27;
    
    if (discriminant > 0) {
      // One real root, two complex
      const sqrtDisc = Math.sqrt(discriminant);
      const u = Math.cbrt(-q / 2 + sqrtDisc);
      const v = Math.cbrt(-q / 2 - sqrtDisc);
      const realRoot = u + v - b / (3 * a);
      
      return [
        { real: realRoot, imaginary: 0 },
        { real: -(u + v) / 2 - b / (3 * a), imaginary: (u - v) * Math.sqrt(3) / 2 },
        { real: -(u + v) / 2 - b / (3 * a), imaginary: -(u - v) * Math.sqrt(3) / 2 }
      ];
    } else if (discriminant === 0) {
      // All real roots, at least two equal
      const u = Math.cbrt(-q / 2);
      const root1 = 2 * u - b / (3 * a);
      const root2 = -u - b / (3 * a);
      
      return [
        { real: root1, imaginary: 0 },
        { real: root2, imaginary: 0 },
        { real: root2, imaginary: 0 }
      ];
    } else {
      // Three distinct real roots
      const r = Math.sqrt(-p * p * p / 27);
      const phi = Math.acos(-q / (2 * r));
      const magnitude = 2 * Math.sqrt(-p / 3);
      
      return [
        { real: magnitude * Math.cos(phi / 3) - b / (3 * a), imaginary: 0 },
        { real: magnitude * Math.cos((phi + 2 * Math.PI) / 3) - b / (3 * a), imaginary: 0 },
        { real: magnitude * Math.cos((phi + 4 * Math.PI) / 3) - b / (3 * a), imaginary: 0 }
      ];
    }
  };

  // Ferrari's method for quartic equations
  const solveQuartic = (a: number, b: number, c: number, d: number, e: number): Solution => {
    if (a === 0) {
      const cubicRoots = solveCubic(b, c, d, e);
      return {
        roots: cubicRoots,
        realRoots: cubicRoots.filter(root => root.imaginary === 0).map(root => root.real),
        discriminant: 0,
        nature: cubicRoots.filter(root => root.imaginary === 0).length === 3 ? "ba nghiệm thực" : "một nghiệm thực, hai nghiệm phức"
      };
    }

    // Normalize: x⁴ + ax³ + bx² + cx + d = 0
    const A = b / a;
    const B = c / a;
    const C = d / a;
    const D = e / a;

    // Depressed quartic: y⁴ + py² + qy + r = 0
    const p = B - (3 * A * A) / 8;
    const q = (A * A * A) / 8 - (A * B) / 2 + C / 2;
    const r = D - (3 * A * A * A * A) / 256 - (A * A * B) / 16 + (A * C) / 4;

    // Solve resolvent cubic: z³ - pz² - 4rz + (4pr - q²) = 0
    const cubicRoots = solveCubic(1, -p, -4 * r, 4 * p * r - q * q);
    const z = cubicRoots[0]; // Use the real root

    // Calculate u and v
    const discriminant_z = z.real * z.real - 4 * r;
    const sqrt_discriminant_z = complexSqrt({ real: discriminant_z, imaginary: 0 });

    const u_half = complexDivide(
      complexAdd(z, sqrt_discriminant_z),
      { real: 2, imaginary: 0 }
    );
    
    const v_half = complexSubtract(
      z,
      sqrt_discriminant_z
    );
    v_half.real /= 2;
    v_half.imaginary /= 2;

    const u = complexSqrt(u_half);
    const v = complexSqrt(v_half);

    // Calculate the roots
    const quarter_A = A / 4;
    
    // First two roots
    const sum_uv = complexAdd(u, v);
    const realSum = sum_uv.real;
    const imagSum = sum_uv.imaginary;

    const term1 = { real: -quarter_A, imaginary: 0 };
    const term2 = complexDivide(sum_uv, { real: 2, imaginary: 0 });

    const root1 = complexAdd(term1, term2);
    const root2 = complexSubtract(term1, term2);

    // Second pair of roots
    const diff_uv = complexSubtract(u, v);
    const term3 = complexDivide(diff_uv, { real: 2, imaginary: 0 });

    const root3 = complexAdd(term1, term3);
    const root4 = complexSubtract(term1, term3);

    const roots = [root1, root2, root3, root4];
    const realRoots = roots.filter(root => Math.abs(root.imaginary) < 1e-10).map(root => root.real);
    
    const discriminant = 256 * D * D * D * D - 192 * A * C * D * D * D - 128 * B * B * D * D * D + 144 * B * C * C * D * D - 27 * C * C * C * C + 144 * A * A * C * D * D * D - 6 * A * A * A * A * D * D - 80 * A * A * B * C * D * D + 18 * A * A * B * B * B * D - 4 * A * A * B * B * C * C + 16 * A * A * C * C * C - 27 * A * A * A * A * D * D - 4 * B * B * B * B * D + B * B * B * C * C - 4 * A * B * B * C * D + 18 * A * B * C * C * D - 4 * A * C * C * C * D - 4 * B * B * C * C * C;

    let nature = '';
    if (realRoots.length === 4) nature = 'bốn nghiệm thực';
    else if (realRoots.length === 2) nature = 'hai nghiệm thực, hai nghiệm phức';
    else if (realRoots.length === 0) nature = 'bốn nghiệm phức';
    else if (realRoots.length === 1) nature = 'một nghiệm thực, ba nghiệm phức';

    return { roots, realRoots, discriminant, nature };
  };

  const handleSolve = () => {
    setIsLoading(true);
    setError('');
    
    try {
      const { a, b, c, d, e } = coefficients;
      
      if (a === 0) {
        throw new Error('Hệ số a phải khác 0 để tạo thành phương trình bậc 4');
      }

      const result = solveQuartic(a, b, c, d, e);
      setSolution(result);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Đã xảy ra lỗi');
      setSolution(null);
    } finally {
      setIsLoading(false);
    }
  };

  const handleInputChange = (coeff: keyof typeof coefficients, value: string) => {
    const numValue = parseFloat(value) || 0;
    setCoefficients(prev => ({ ...prev, [coeff]: numValue }));
  };

  const formatComplexNumber = (num: ComplexNumber): string => {
    if (Math.abs(num.imaginary) < 1e-10) {
      return num.real.toFixed(6);
    }
    
    const realPart = Math.abs(num.real) < 1e-10 ? '' : num.real.toFixed(6);
    const imagPart = Math.abs(num.imaginary) < 1e-10 ? '' : Math.abs(num.imaginary).toFixed(6);
    
    if (realPart && imagPart) {
      return `${realPart} ${num.imaginary >= 0 ? '+' : '-'} ${imagPart}i`;
    } else if (imagPart) {
      return `${num.imaginary >= 0 ? '' : '-'}${imagPart}i`;
    } else {
      return realPart;
    }
  };

  const renderEquation = () => {
    const { a, b, c, d, e } = coefficients;
    const terms = [];
    
    if (a !== 0) terms.push(`${a === 1 ? '' : a === -1 ? '-' : a}x⁴`);
    if (b !== 0) terms.push(`${b > 0 ? '+' : '-'} ${Math.abs(b) === 1 ? '' : Math.abs(b)}x³`);
    if (c !== 0) terms.push(`${c > 0 ? '+' : '-'} ${Math.abs(c) === 1 ? '' : Math.abs(c)}x²`);
    if (d !== 0) terms.push(`${d > 0 ? '+' : '-'} ${Math.abs(d) === 1 ? '' : Math.abs(d)}x`);
    if (e !== 0 || terms.length === 0) terms.push(`${e > 0 ? '+' : '-'} ${Math.abs(e)}`);
    
    return terms.join(' ') + ' = 0';
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
      <div className="max-w-6xl mx-auto">
        {/* Header */}
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-gray-800 mb-4">
            Phần Mềm Giải Phương Trình Bậc 4
          </h1>
          <p className="text-lg text-gray-600">
            Giải phương trình dạng ax⁴ + bx³ + cx² + dx + e = 0
          </p>
        </div>

        <div className="grid lg:grid-cols-2 gap-8">
          {/* Input Section */}
          <div className="bg-white rounded-2xl shadow-xl p-8">
            <h2 className="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
              <span className="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">1</span>
              Nhập Hệ Số
            </h2>
            
            <div className="space-y-6">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Hệ số a (x⁴)
                </label>
                <input
                  type="number"
                  value={coefficients.a}
                  onChange={(e) => handleInputChange('a', e.target.value)}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="1"
                  step="any"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Hệ số b (x³)
                </label>
                <input
                  type="number"
                  value={coefficients.b}
                  onChange={(e) => handleInputChange('b', e.target.value)}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="0"
                  step="any"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Hệ số c (x²)
                </label>
                <input
                  type="number"
                  value={coefficients.c}
                  onChange={(e) => handleInputChange('c', e.target.value)}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="0"
                  step="any"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Hệ số d (x)
                </label>
                <input
                  type="number"
                  value={coefficients.d}
                  onChange={(e) => handleInputChange('d', e.target.value)}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="0"
                  step="any"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Hệ số e (hằng số)
                </label>
                <input
                  type="number"
                  value={coefficients.e}
                  onChange={(e) => handleInputChange('e', e.target.value)}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="0"
                  step="any"
                />
              </div>
            </div>

            {/* Equation Display */}
            <div className="mt-8 p-4 bg-gray-50 rounded-lg">
              <h3 className="text-lg font-medium text-gray-700 mb-2">Phương trình:</h3>
              <div className="text-xl font-mono text-gray-800 bg-white p-3 rounded border">
                {renderEquation()}
              </div>
            </div>

            {/* Solve Button */}
            <button
              onClick={handleSolve}
              disabled={isLoading || coefficients.a === 0}
              className="w-full mt-6 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold py-4 px-6 rounded-lg hover:from-blue-600 hover:to-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 flex items-center justify-center"
            >
              {isLoading ? (
                <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div>
              ) : (
                'Giải Phương Trình'
              )}
            </button>

            {error && (
              <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                <p className="text-red-600">{error}</p>
              </div>
            )}
          </div>

          {/* Results Section */}
          <div className="bg-white rounded-2xl shadow-xl p-8">
            <h2 className="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
              <span className="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">2</span>
              Kết Quả
            </h2>

            {solution ? (
              <div className="space-y-6">
                {/* Nature of Roots */}
                <div className="p-4 bg-blue-50 rounded-lg">
                  <h3 className="text-lg font-semibold text-blue-800 mb-2">Tính chất nghiệm:</h3>
                  <p className="text-blue-700">{solution.nature}</p>
                </div>

                {/* All Roots */}
                <div>
                  <h3 className="text-lg font-semibold text-gray-800 mb-4">Tất cả nghiệm:</h3>
                  <div className="space-y-3">
                    {solution.roots.map((root, index) => (
                      <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span className="font-mono text-gray-600">x{index + 1} =</span>
                        <span className="font-mono text-lg font-semibold text-gray-800">
                          {formatComplexNumber(root)}
                        </span>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Real Roots Summary */}
                {solution.realRoots.length > 0 && (
                  <div>
                    <h3 className="text-lg font-semibold text-gray-800 mb-4">Nghiệm thực:</h3>
                    <div className="grid grid-cols-2 gap-3">
                      {solution.realRoots.map((root, index) => (
                        <div key={index} className="p-3 bg-green-50 rounded-lg text-center">
                          <span className="font-mono text-green-700 font-semibold">
                            {root.toFixed(6)}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Additional Information */}
                <div className="p-4 bg-gray-50 rounded-lg">
                  <h3 className="text-lg font-semibold text-gray-800 mb-2">Thông tin thêm:</h3>
                  <div className="text-sm text-gray-600 space-y-1">
                    <p>Số nghiệm thực: {solution.realRoots.length}</p>
                    <p>Số nghiệm phức: {4 - solution.realRoots.length}</p>
                    <p>Discriminant: {solution.discriminant.toFixed(6)}</p>
                  </div>
                </div>
              </div>
            ) : (
              <div className="text-center py-12">
                <div className="w-24 h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                  <svg className="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                  </svg>
                </div>
                <p className="text-gray-500">Nhập hệ số và nhấn "Giải Phương Trình" để xem kết quả</p>
              </div>
            )}
          </div>
        </div>

        {/* Information Section */}
        <div className="mt-8 bg-white rounded-2xl shadow-xl p-8">
          <h2 className="text-2xl font-semibold text-gray-800 mb-6">Hướng Dẫn Sử Dụng</h2>
          <div className="grid md:grid-cols-2 gap-8">
            <div>
              <h3 className="text-lg font-semibold text-gray-700 mb-3">Cách nhập phương trình:</h3>
              <ul className="space-y-2 text-gray-600">
                <li>• Nhập hệ số a, b, c, d, e tương ứng với các số hạng</li>
                <li>• Hệ số a không được bằng 0</li>
                <li>• Có thể nhập số âm hoặc số thập phân</li>
                <li>• Ví dụ: x⁴ - 5x² + 6 = 0 → a=1, b=0, c=-5, d=0, e=6</li>
              </ul>
            </div>
            <div>
              <h3 className="text-lg font-semibold text-gray-700 mb-3">Hiểu kết quả:</h3>
              <ul className="space-y-2 text-gray-600">
                <li>• Nghiệm phức có dạng: a + bi</li>
                <li>• Chỉ hiển thị phần thực khi phần ảo ≈ 0</li>
                <li>• Phương trình bậc 4 có tối đa 4 nghiệm</li>
                <li>• Nghiệm có thể là thực hoặc phức</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default QuarticEquationSolver;
